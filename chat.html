<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentScope -- Alibaba</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.21.4/babel.min.js"></script>
    <script src="https://unpkg.com/marked@4.3.0/marked.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script>
        // ÊÄßËÉΩÁõëÊéß
        console.log('üïê HTML Ëß£ÊûêÂÆåÊàê:', new Date().toISOString());
        window.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ DOM Âä†ËΩΩÂÆåÊàê:', new Date().toISOString());
        });
        window.addEventListener('load', () => {
            console.log('‚úÖ ÊâÄÊúâËµÑÊ∫êÂä†ËΩΩÂÆåÊàê:', new Date().toISOString());
            if (window.performance) {
                const perfData = window.performance.timing;
                const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
                const domReadyTime = perfData.domContentLoadedEventEnd - perfData.navigationStart;
                const resourceLoadTime = perfData.loadEventEnd - perfData.domContentLoadedEventEnd;
                console.log('üìä È°µÈù¢Âä†ËΩΩËÄóÊó∂:', pageLoadTime + 'ms');
                console.log('üìä DOMËß£ÊûêËÄóÊó∂:', domReadyTime + 'ms');
                console.log('üìä ËµÑÊ∫êÂä†ËΩΩËÄóÊó∂:', resourceLoadTime + 'ms');
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background: #e3f2fd;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #three-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        #root {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.15),
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        .chat-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        .chat-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e8e8e8;
            background: linear-gradient(135deg, #0064c8 0%, #1890ff 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .chat-header::before {
            content: '‚òÅÔ∏è';
            position: absolute;
            left: 20px;
            font-size: 24px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        .chat-header-left {
            margin-left: 40px;
        }

        .chat-header-left h1 {
            font-size: 20px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .new-chat-button {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 4px;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
        }

        .new-chat-button:hover {
            background: white;
            color: #1890ff;
            border-color: white;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
            z-index: 2;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Ctext x='50' y='100' font-size='24' font-family='Arial' fill='rgba(100,181,246,0.08)' transform='rotate(-45 200 200)'%3Eagentscope%3C/text%3E%3Ctext x='50' y='250' font-size='24' font-family='Arial' fill='rgba(100,181,246,0.08)' transform='rotate(-45 200 200)'%3Eagentscope%3C/text%3E%3Ctext x='200' y='175' font-size='24' font-family='Arial' fill='rgba(100,181,246,0.08)' transform='rotate(-45 200 200)'%3Eagentscope%3C/text%3E%3C/svg%3E");
            background-repeat: repeat;
        }

        .plan-bubble {
            width: 350px;
            height: 90vh;
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.95) 0%, rgba(0, 100, 200, 0.95) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.15),
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            font-size: 14px;
            line-height: 1.6;
            animation: slideIn 0.3s ease-out;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }

        .plan-bubble strong {
            font-size: 15px;
        }

        .plan-description {
            margin-top: 8px;
            opacity: 0.95;
            font-size: 13px;
        }

        .plan-subtasks {
            margin-top: 12px;
        }

        .subtask-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 6px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .subtask-state {
            font-size: 16px;
            line-height: 1;
            flex-shrink: 0;
        }

        .subtask-content {
            flex: 1;
        }

        .subtask-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .subtask-description {
            font-size: 12px;
            opacity: 0.9;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #0064c8 0%, #1890ff 100%);
            color: white;
        }

        .message.assistant .message-bubble {
            background: #f0f0f0;
            color: #333;
        }

        .message-content-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
        }

        .message-content-item:last-child {
            margin-bottom: 0;
        }

        .message-content-item.text {
            background: transparent;
            color: #333;
            line-height: 1.8;
        }

        .message-content-item.tool_use {
            background: rgba(255, 152, 0, 0.1);
            color: #e65100;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid #ff9800;
            position: relative;
        }

        .message-content-item.tool_use.loading::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, 
                rgba(255, 152, 0, 0) 0%,
                rgba(255, 152, 0, 0.8) 50%,
                rgba(255, 152, 0, 0) 100%);
            background-size: 100% 200%;
            animation: loading-slide 1.5s ease-in-out infinite;
        }

        @keyframes loading-slide {
            0% {
                background-position: 0% 0%;
            }
            50% {
                background-position: 0% 100%;
            }
            100% {
                background-position: 0% 0%;
            }
        }

        .message-content-item.tool_use:hover {
            background: rgba(255, 152, 0, 0.15);
        }

        .message-content-item.tool_result {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-left: 16px;
            border-left: 3px solid #4caf50;
            max-height: 200px;
            overflow-y: auto;
        }

        .tool-use-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-use-toggle {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .tool-use-toggle.expanded {
            transform: rotate(90deg);
        }

        .message-content-item.error {
            background: rgba(244, 67, 54, 0.1);
            color: #c62828;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            position: relative;
            z-index: 2;
        }

        .chat-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .chat-input:focus {
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }

        .chat-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .send-button {
            padding: 10px 24px;
            background: linear-gradient(135deg, #0064c8 0%, #1890ff 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-button:hover:not(:disabled) {
            opacity: 0.9;
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .deep-search-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #fafafa;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .deep-search-toggle:hover {
            background: #f0f0f0;
            border-color: #1890ff;
        }

        .deep-search-toggle.active {
            background: linear-gradient(135deg, #0064c8 0%, #1890ff 100%);
            color: white;
            border-color: #1890ff;
        }

        .toggle-switch {
            width: 36px;
            height: 20px;
            background: #ccc;
            border-radius: 10px;
            position: relative;
            transition: background 0.3s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .deep-search-toggle.active .toggle-switch {
            background: rgba(255, 255, 255, 0.3);
        }

        .deep-search-toggle.active .toggle-switch::after {
            transform: translateX(16px);
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 600;
        }

        .loading-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1890ff;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        /* tool_use loading Ê†∑Âºè */
        .tool-use-loading {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .tool-use-loading-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ff9800;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .tool-use-loading-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .tool-use-loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .tool-use-loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Markdown Ê†∑Âºè */
        .markdown-content {
            line-height: 1.8;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .markdown-content h1 { font-size: 1.8em; }
        .markdown-content h2 { font-size: 1.5em; }
        .markdown-content h3 { font-size: 1.3em; }

        .markdown-content p {
            margin-bottom: 8px;
        }

        .markdown-content code {
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-left: 20px;
            margin-bottom: 8px;
        }

        .markdown-content li {
            margin-bottom: 4px;
        }

        .markdown-content blockquote {
            border-left: 3px solid #1890ff;
            padding-left: 12px;
            margin: 8px 0;
            color: #666;
            background: #e6f7ff;
            padding: 8px 12px;
        }

        .markdown-content a {
            color: #1890ff;
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 8px 0;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .markdown-content table th {
            background: #fafafa;
            font-weight: 500;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            display: block;
        }

        /* CD ÊóãËΩ¨Âä®Áîª */
        .music-player {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .cd-container {
            position: relative;
            width: 45px;
            height: 45px;
        }

        .cd-disc {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a1a1a 0%, #3a3a3a 100%);
            box-shadow: 
                inset 0 0 0 8px rgba(255, 255, 255, 0.1),
                inset 0 0 0 9px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .cd-disc:not(.paused) {
            animation: rotate 4s linear infinite;
        }

        .cd-disc::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #888 0%, #333 100%);
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .cd-disc::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                rgba(255, 255, 255, 0.1) 0deg,
                transparent 90deg,
                transparent 180deg,
                rgba(255, 255, 255, 0.1) 270deg,
                transparent 360deg
            );
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .music-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .music-title {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .music-artist {
            font-size: 11px;
            color: #666;
        }

        .music-player:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .play-pause-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0064c8 0%, #1890ff 100%);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        }

        .play-pause-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.5);
        }

        .play-pause-btn:active {
            transform: scale(0.95);
        }

        .cd-disc.paused {
            animation-play-state: paused;
        }

        /* ÊäÄËÉΩÊèêÁ§∫Ê°ÜÊ†∑Âºè */
        .skill-suggestions {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-bottom: 8px;
        }

        .skill-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .skill-item:last-child {
            border-bottom: none;
        }

        .skill-item:hover,
        .skill-item.selected {
            background: #e6f7ff;
        }

        .skill-name {
            font-weight: 500;
            color: #1890ff;
            margin-bottom: 4px;
        }

        .skill-description {
            font-size: 12px;
            color: #666;
        }

        .skill-suggestions-empty {
            padding: 12px 16px;
            color: #999;
            text-align: center;
        }

        /* ÂõæÁâá‰∏ä‰º†Ê†∑Âºè */
        .image-upload-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .image-upload-btn {
            padding: 10px 16px;
            background: #fafafa;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .image-upload-btn:hover {
            background: #f0f0f0;
            border-color: #1890ff;
        }

        .image-preview-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            max-width: 300px;
        }

        .image-preview {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #d9d9d9;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .image-preview .remove-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        /* Áî®Êà∑Ê∂àÊÅØ‰∏≠ÁöÑÂõæÁâáÊ†∑Âºè */
        .user-images {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .user-images img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            object-fit: cover;
        }

        /* ÊâìÊñ≠ÊåâÈíÆÊ†∑Âºè */
        .stop-button {
            padding: 10px 24px;
            background: linear-gradient(135deg, #0064c8 0%, #1890ff 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stop-button:hover {
            opacity: 0.9;
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
        }

        .stop-button:active {
            transform: scale(0.95);
        }

        .stop-icon {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <canvas id="three-background"></canvas>
    
    <!-- CD Èü≥‰πêÊí≠ÊîæÂô® -->
    <div class="music-player">
        <div class="cd-container">
            <div class="cd-disc" id="cd-disc"></div>
        </div>
        <div class="music-info">
            <div class="music-title" id="music-status">Â∑≤ÊöÇÂÅú</div>
            <div class="music-artist">Âë®Êù∞‰º¶ - ÊòüÊô¥</div>
        </div>
        <button class="play-pause-btn" id="playPauseBtn" title="Êí≠Êîæ/ÊöÇÂÅú">‚ñ∂</button>
    </div>
    
    <div id="root"></div>
    
    <!-- ËÉåÊôØÈü≥‰πê -->
    <audio id="bgm" loop preload="auto">
        <source src="/music/jay-xingqing.mp4" type="audio/mp4">
        ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ„ÄÇ
    </audio>
    <script>
        // ÊâãÂä®ÊéßÂà∂Èü≥‰πêÊí≠Êîæ
        const bgm = document.getElementById('bgm');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const cdDisc = document.getElementById('cd-disc');
        const musicStatus = document.getElementById('music-status');
        let isPlaying = false;
        
        bgm.volume = 0.3;
        
        // ÂàùÂßãÁä∂ÊÄÅÔºöCD ÈùôÊ≠¢
        cdDisc.classList.add('paused');
        
        // Êí≠Êîæ/ÊöÇÂÅúÂàáÊç¢ÂáΩÊï∞
        function togglePlayPause() {
            if (isPlaying) {
                bgm.pause();
                playPauseBtn.textContent = '‚ñ∂';
                cdDisc.classList.add('paused');
                musicStatus.textContent = 'Â∑≤ÊöÇÂÅú';
                isPlaying = false;
            } else {
                bgm.play().catch(e => {
                    console.log('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e);
                    playPauseBtn.textContent = '‚ñ∂';
                });
                playPauseBtn.textContent = '‚è∏';
                cdDisc.classList.remove('paused');
                musicStatus.textContent = 'Ê≠£Âú®Êí≠Êîæ';
                isPlaying = true;
            }
        }
        
        // ÁªëÂÆöÊí≠Êîæ/ÊöÇÂÅúÊåâÈíÆ‰∫ã‰ª∂
        playPauseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            togglePlayPause();
        });
        
        // ÁõëÂê¨Èü≥È¢ëÊí≠ÊîæÁä∂ÊÄÅÂèòÂåñ
        bgm.addEventListener('play', () => {
            playPauseBtn.textContent = '‚è∏';
            cdDisc.classList.remove('paused');
            musicStatus.textContent = 'Ê≠£Âú®Êí≠Êîæ';
            isPlaying = true;
        });
        
        bgm.addEventListener('pause', () => {
            playPauseBtn.textContent = '‚ñ∂';
            cdDisc.classList.add('paused');
            musicStatus.textContent = 'Â∑≤ÊöÇÂÅú';
            isPlaying = false;
        });
    </script>

    <script>
        // Three.js Â§©Á©∫È£ûÁøîËÉåÊôØ
        const canvas = document.getElementById('three-background');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x87CEEB, 1); // Â§©Á©∫ËìùËâ≤
        
        // ÂàõÂª∫Êõ¥ÁúüÂÆûÁöÑ‰∫ëÊúµÔºà‰ΩøÁî®Â§ö‰∏™ÁêÉ‰ΩìÁªÑÂêàÔºâ
        const clouds = [];
        for (let i = 0; i < 30; i++) {
            const cloudGroup = new THREE.Group();
            const numPuffs = 5 + Math.floor(Math.random() * 5);
            
            for (let j = 0; j < numPuffs; j++) {
                const puffGeometry = new THREE.SphereGeometry(
                    Math.random() * 0.8 + 0.5,
                    16,
                    16
                );
                const puffMaterial = new THREE.MeshBasicMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.7 + Math.random() * 0.2
                });
                const puff = new THREE.Mesh(puffGeometry, puffMaterial);
                puff.position.x = (Math.random() - 0.5) * 3;
                puff.position.y = (Math.random() - 0.5) * 1.5;
                puff.position.z = (Math.random() - 0.5) * 2;
                cloudGroup.add(puff);
            }
            
            cloudGroup.position.x = Math.random() * 100 - 50;
            cloudGroup.position.y = Math.random() * 30 - 10;
            cloudGroup.position.z = Math.random() * -100 - 10;
            cloudGroup.scale.set(
                Math.random() * 1.5 + 1,
                Math.random() * 0.8 + 0.6,
                Math.random() * 1.2 + 0.8
            );
            clouds.push(cloudGroup);
            scene.add(cloudGroup);
        }
        
        // ÂàõÂª∫ÁÉ≠Ê∞îÁêÉÔºàÂ¢ûÂä†Êï∞ÈáèÂà∞10‰∏™Ôºâ
        const balloons = [];
        for (let i = 0; i < 10; i++) {
            const balloonGroup = new THREE.Group();
            
            // Ê∞îÁêÉ‰∏ª‰Ωì
            const balloonGeometry = new THREE.SphereGeometry(1.5, 16, 16);
            const colors = [
                0xff6b6b, 0x4ecdc4, 0xffe66d, 0x95e1d3, 
                0xf38181, 0xaa96da, 0xfcbad3, 0xa8e6cf,
                0xff9ff3, 0xfeca57
            ];
            const balloonMaterial = new THREE.MeshBasicMaterial({
                color: colors[i],
                transparent: true,
                opacity: 0.85
            });
            const balloon = new THREE.Mesh(balloonGeometry, balloonMaterial);
            balloon.scale.y = 1.2;
            balloonGroup.add(balloon);
            
            // ÁØÆÂ≠ê
            const basketGeometry = new THREE.BoxGeometry(0.8, 0.6, 0.8);
            const basketMaterial = new THREE.MeshBasicMaterial({ color: 0x8B4513 });
            const basket = new THREE.Mesh(basketGeometry, basketMaterial);
            basket.position.y = -2;
            balloonGroup.add(basket);
            
            // ËøûÊé•Á∫ø
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x333333 });
            for (let j = 0; j < 4; j++) {
                const points = [];
                points.push(new THREE.Vector3(
                    Math.cos(j * Math.PI / 2) * 0.8,
                    -1.2,
                    Math.sin(j * Math.PI / 2) * 0.8
                ));
                points.push(new THREE.Vector3(
                    Math.cos(j * Math.PI / 2) * 0.4,
                    -2,
                    Math.sin(j * Math.PI / 2) * 0.4
                ));
                const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
                const line = new THREE.Line(lineGeometry, lineMaterial);
                balloonGroup.add(line);
            }
            
            // ÂàÜÂ∏ÉÂú®Êï¥‰∏™Â§©Á©∫‰∏≠ÔºàÊõ¥ÂπøÁöÑËåÉÂõ¥Ôºâ
            balloonGroup.position.x = Math.random() * 120 - 60;
            balloonGroup.position.y = Math.random() * 30 + 5;
            balloonGroup.position.z = Math.random() * -120 - 20;
            balloons.push({
                group: balloonGroup,
                speed: Math.random() * 0.015 + 0.008,
                floatOffset: Math.random() * Math.PI * 2
            });
            scene.add(balloonGroup);
        }
        
        // ÂàõÂª∫È£ûÊú∫ÔºàÊõ¥ÈÄºÁúüÁöÑËÆæËÆ°Ôºâ
        const planes = [];
        for (let i = 0; i < 2; i++) {
            const planeGroup = new THREE.Group();
            
            // Êú∫Ë∫´ÔºàÊµÅÁ∫øÂûãÔºâ
            const bodyGeometry = new THREE.CylinderGeometry(0.25, 0.35, 4, 12);
            const bodyMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.rotation.z = Math.PI / 2;
            planeGroup.add(body);
            
            // Êú∫Â§¥ÔºàÂúÜÈî•ÂΩ¢Ôºâ
            const noseGeometry = new THREE.ConeGeometry(0.25, 0.8, 12);
            const nose = new THREE.Mesh(noseGeometry, bodyMaterial);
            nose.rotation.z = -Math.PI / 2;
            nose.position.x = 2.4;
            planeGroup.add(nose);
            
            // ‰∏ªÊú∫ÁøºÔºàÊõ¥Â§ßÊõ¥ÁúüÂÆûÔºâ
            const wingGeometry = new THREE.BoxGeometry(8, 0.08, 2);
            const wingMaterial = new THREE.MeshBasicMaterial({ color: 0xe0e0e0 });
            const wings = new THREE.Mesh(wingGeometry, wingMaterial);
            wings.position.x = 0.5;
            planeGroup.add(wings);
            
            // Êú∫ÁøºÁøºÂ∞ñ
            const wingTipGeometry = new THREE.BoxGeometry(0.3, 0.08, 0.3);
            const wingTipMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            const wingTip1 = new THREE.Mesh(wingTipGeometry, wingTipMaterial);
            wingTip1.position.set(0.5, 0, 1.15);
            planeGroup.add(wingTip1);
            const wingTip2 = wingTip1.clone();
            wingTip2.position.z = -1.15;
            planeGroup.add(wingTip2);
            
            // Â∞æÁøºÔºàÂûÇÁõ¥Ôºâ
            const vTailGeometry = new THREE.BoxGeometry(0.08, 1.5, 1.2);
            const vTail = new THREE.Mesh(vTailGeometry, wingMaterial);
            vTail.position.x = -1.5;
            planeGroup.add(vTail);
            
            // Ê∞¥Âπ≥Â∞æÁøº
            const hTailGeometry = new THREE.BoxGeometry(0.08, 2.5, 0.8);
            const hTail = new THREE.Mesh(hTailGeometry, wingMaterial);
            hTail.rotation.x = Math.PI / 2;
            hTail.position.set(-1.5, 0.7, 0);
            planeGroup.add(hTail);
            
            // ÂºïÊìé
            const engineGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.8, 12);
            const engineMaterial = new THREE.MeshBasicMaterial({ color: 0x555555 });
            const engine1 = new THREE.Mesh(engineGeometry, engineMaterial);
            engine1.rotation.z = Math.PI / 2;
            engine1.position.set(0.5, 0, 2);
            planeGroup.add(engine1);
            const engine2 = engine1.clone();
            engine2.position.z = -2;
            planeGroup.add(engine2);
            
            // È©æÈ©∂Ëà±Á™óÊà∑
            const windowGeometry = new THREE.SphereGeometry(0.3, 8, 8);
            const windowMaterial = new THREE.MeshBasicMaterial({ color: 0x1a1a2e, transparent: true, opacity: 0.8 });
            const window1 = new THREE.Mesh(windowGeometry, windowMaterial);
            window1.position.set(1.3, 0.3, 0);
            window1.scale.set(0.8, 0.6, 0.6);
            planeGroup.add(window1);
            
            planeGroup.position.x = i === 0 ? -50 : 60;
            planeGroup.position.y = Math.random() * 10 + 8;
            planeGroup.position.z = Math.random() * -80 - 40;
            planeGroup.rotation.y = i === 0 ? Math.PI / 8 : -Math.PI / 8;
            planeGroup.scale.set(0.8, 0.8, 0.8);
            planes.push({
                group: planeGroup,
                speed: 0.4 + Math.random() * 0.2,
                direction: i === 0 ? 1 : -1,
                wobble: Math.random() * Math.PI * 2
            });
            scene.add(planeGroup);
        }
        
        // Ê∑ªÂä†ÊòüÊòüÁ≤íÂ≠êÔºàÂáèÂ∞ëÊï∞ÈáèÔºâ
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 100;
        const posArray = new Float32Array(particlesCount * 3);
        
        for (let i = 0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 200;
        }
        
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.2,
            color: 0xffffff,
            transparent: true,
            opacity: 0.5
        });
        
        const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);
        
        camera.position.z = 5;
        camera.position.y = 0;
        
        let time = 0;
        
        // Âä®ÁîªÂæ™ÁéØ
        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;
            
            // ‰∫ëÊúµÂêëÂâçÁßªÂä®Âπ∂ËΩªÂæÆÊºÇÊµÆ
            clouds.forEach((cloud, index) => {
                cloud.position.z += 0.05 + index * 0.002;
                cloud.position.y += Math.sin(time + index) * 0.01;
                if (cloud.position.z > 10) {
                    cloud.position.z = -100;
                    cloud.position.x = Math.random() * 100 - 50;
                }
            });
            
            // ÁÉ≠Ê∞îÁêÉÊºÇÊµÆ
            balloons.forEach(balloon => {
                balloon.group.position.z += balloon.speed;
                balloon.group.position.y += Math.sin(time * 2 + balloon.floatOffset) * 0.02;
                balloon.group.rotation.y = Math.sin(time + balloon.floatOffset) * 0.1;
                if (balloon.group.position.z > 20) {
                    balloon.group.position.z = -120;
                    balloon.group.position.x = Math.random() * 120 - 60;
                    balloon.group.position.y = Math.random() * 30 + 5;
                }
            });
            
            // È£ûÊú∫È£ûË°å
            planes.forEach(plane => {
                plane.group.position.x += plane.speed * plane.direction;
                // Êõ¥Ëá™ÁÑ∂ÁöÑ‰∏ä‰∏ãËµ∑‰ºè
                plane.group.position.y += Math.sin(time * 2 + plane.wobble) * 0.04;
                // ËΩªÂæÆÁöÑÂÄæÊñúÊëáÊëÜ
                plane.group.rotation.z = Math.sin(time * 3 + plane.wobble) * 0.05;
                plane.group.rotation.x = Math.sin(time * 2.5 + plane.wobble) * 0.03;
                
                if (Math.abs(plane.group.position.x) > 70) {
                    plane.group.position.x = -70 * plane.direction;
                    plane.group.position.z = Math.random() * -80 - 40;
                    plane.group.position.y = Math.random() * 10 + 8;
                }
            });
            
            // Á≤íÂ≠êËΩªÂæÆÊóãËΩ¨
            particlesMesh.rotation.y += 0.0003;
            
            // Áõ∏Êú∫ËΩªÂæÆ‰∏ä‰∏ãÊµÆÂä®
            camera.position.y = Math.sin(time * 0.5) * 0.3;
            
            renderer.render(scene, camera);
        }
        
        animate();
        
        // ÂìçÂ∫îÁ™óÂè£Â§ßÂ∞èÂèòÂåñ
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>

    <script type="text/babel">
        console.log('üöÄ ÂºÄÂßãÊâßË°å React ‰ª£Á†Å:', new Date().toISOString());
        const { useState, useEffect, useRef } = React;

        // ÈÖçÁΩÆ marked
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true
            });
        }

        // ÁîüÊàê UUID v4
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function ChatApp() {
            const [sessionId] = useState(() => generateUUID());
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [currentPlan, setCurrentPlan] = useState(null);
            const [isAutoScroll, setIsAutoScroll] = useState(true);
            const [deepSearch, setDeepSearch] = useState(false);
            const [expandedToolUseIds, setExpandedToolUseIds] = useState(new Set()); // Ë∑üË∏™Â±ïÂºÄÁöÑ tool_use
            const [skills, setSkills] = useState([]); // ÂèØÁî®ÊäÄËÉΩÂàóË°®
            const [showSkillSuggestions, setShowSkillSuggestions] = useState(false); // ÊòØÂê¶ÊòæÁ§∫ÊäÄËÉΩÊèêÁ§∫
            const [selectedSkillIndex, setSelectedSkillIndex] = useState(0); // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊäÄËÉΩÁ¥¢Âºï
            const [selectedImages, setSelectedImages] = useState([]); // ÈÄâ‰∏≠ÁöÑÂõæÁâáÂàóË°®
            const messagesEndRef = useRef(null);
            const messagesContainerRef = useRef(null);
            const inputRef = useRef(null); // ËæìÂÖ•Ê°ÜÂºïÁî®
            const fileInputRef = useRef(null); // Êñá‰ª∂ËæìÂÖ•ÂºïÁî®
            const userScrolledRef = useRef(false); // Ë∑üË∏™Áî®Êà∑ÊòØÂê¶‰∏ªÂä®ÊªöÂä®
            const isAutoScrollingRef = useRef(false); // Ë∑üË∏™ÊòØÂê¶Ê≠£Âú®Ëá™Âä®ÊªöÂä®

            // Âä†ËΩΩÊäÄËÉΩÂàóË°®
            useEffect(() => {
                const fetchSkills = async () => {
                    try {
                        console.log('ÂºÄÂßãËé∑ÂèñÊäÄËÉΩÂàóË°®...');
                        const response = await fetch('/get_skills');
                        console.log('ÊäÄËÉΩÊé•Âè£ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                        if (response.ok) {
                            const data = await response.json();
                            console.log('ÊäÄËÉΩÊé•Âè£ËøîÂõûÊï∞ÊçÆ:', data);
                            // Â§ÑÁêÜ‰∏çÂêåÁöÑËøîÂõûÊ†ºÂºè
                            let skillsList = [];
                            if (Array.isArray(data)) {
                                skillsList = data;
                            } else if (data.skills && Array.isArray(data.skills)) {
                                skillsList = data.skills;
                            } else if (typeof data === 'object') {
                                // Â¶ÇÊûúÊòØÂØπË±°ÔºåÂ∞ùËØïÊèêÂèñÊäÄËÉΩÂàóË°®
                                skillsList = Object.values(data);
                            }
                            setSkills(skillsList);
                            console.log('Â∑≤Âä†ËΩΩÊäÄËÉΩÂàóË°®:', skillsList);
                        } else {
                            console.error('Ëé∑ÂèñÊäÄËÉΩÂàóË°®Â§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å:', response.status);
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩÊäÄËÉΩÂàóË°®Â§±Ë¥•:', error);
                    }
                };
                fetchSkills();
            }, []);

            // ÁõëÂê¨ËæìÂÖ•ÂèòÂåñÔºåÊòæÁ§∫/ÈöêËóèÊäÄËÉΩÊèêÁ§∫
            useEffect(() => {
                // Âè™Ë¶ÅËæìÂÖ•Ê°ÜÂÜÖÂÆπÂåÖÂê´ / Â∞±ÊòæÁ§∫ÊèêÁ§∫ÔºàÂèØ‰ª•Âú®‰ªª‰Ωï‰ΩçÁΩÆÔºâ
                const slashIndex = inputText.indexOf('/');
                if (slashIndex !== -1) {
                    // ÊèêÂèñ / ÂêéÁöÑÊü•ËØ¢ÊñáÊú¨
                    const query = inputText.substring(slashIndex + 1).toLowerCase().trim();
                    if (skills.length === 0) {
                        setShowSkillSuggestions(false);
                    } else if (query === '') {
                        // ÊòæÁ§∫ÊâÄÊúâÊäÄËÉΩ
                        setShowSkillSuggestions(true);
                    } else {
                        // Ê†πÊçÆËæìÂÖ•ËøáÊª§ÊäÄËÉΩ
                        const filteredSkills = skills.filter(skill => {
                            const skillName = skill.name || '';
                            const skillDesc = skill.description || '';
                            return skillName.toLowerCase().includes(query) || 
                                   skillDesc.toLowerCase().includes(query);
                        });
                        setShowSkillSuggestions(filteredSkills.length > 0);
                    }
                    setSelectedSkillIndex(0);
                } else {
                    setShowSkillSuggestions(false);
                }
            }, [inputText, skills]);

            // Ê∏≤Êüì Plan ÁªÑ‰ª∂
            const renderPlan = (plan) => {
                if (!plan) return null;

                const getStateIcon = (state) => {
                    switch (state) {
                        case 'done':
                            return '‚úì';
                        case 'in_progress':
                            return '‚ü≥';
                        case 'abandoned':
                            return '‚úó';
                        case 'todo':
                        default:
                            return '‚óã';
                    }
                };

                const getStateText = (state) => {
                    switch (state) {
                        case 'done':
                            return 'Â∑≤ÂÆåÊàê';
                        case 'in_progress':
                            return 'ËøõË°å‰∏≠';
                        case 'abandoned':
                            return 'Â∑≤ÊîæÂºÉ';
                        case 'todo':
                        default:
                            return 'ÂæÖÂ§ÑÁêÜ';
                    }
                };

                return (
                    <div className="plan-bubble">
                        <strong>üìã {plan.name || 'ËÆ°Âàí'}</strong>
                        {plan.description && (
                            <div className="plan-description">
                                {plan.description}
                            </div>
                        )}
                        {plan.subtasks && plan.subtasks.length > 0 && (
                            <div className="plan-subtasks">
                                {plan.subtasks.map((subtask, idx) => (
                                    <div key={idx} className="subtask-item">
                                        <div className="subtask-state" title={getStateText(subtask.state)}>
                                            {getStateIcon(subtask.state)}
                                        </div>
                                        <div className="subtask-content">
                                            <div className="subtask-name">
                                                {subtask.name}
                                            </div>
                                            {subtask.description && (
                                                <div className="subtask-description">
                                                    {subtask.description}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            const scrollToBottom = () => {
                if (messagesEndRef.current) {
                    isAutoScrollingRef.current = true;
                    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                    // ÊªöÂä®Âä®ÁîªÂ§ßÁ∫¶ÈúÄË¶Å300-500msÔºåÁªôË∂≥Â§üÊó∂Èó¥ÈÅøÂÖçËØØÂà§
                    setTimeout(() => {
                        isAutoScrollingRef.current = false;
                    }, 600);
                }
            };

            // ÊµÅÂºèËøîÂõûËøáÁ®ã‰∏≠Ëá™Âä®ÊªöÂä®
            useEffect(() => {
                if (!userScrolledRef.current) {
                    const timer = setTimeout(() => {
                        scrollToBottom();
                    }, 50);
                    return () => clearTimeout(timer);
                }
            }, [messages, currentPlan]);

            const handleScroll = () => {
                const container = messagesContainerRef.current;
                if (!container) return;
                
                // Â¶ÇÊûúÊòØËá™Âä®ÊªöÂä®Ëß¶ÂèëÁöÑÔºåÂøΩÁï•
                if (isAutoScrollingRef.current) return;
                
                const { scrollTop, scrollHeight, clientHeight } = container;
                const distanceToBottom = scrollHeight - scrollTop - clientHeight;
                
                // Â¶ÇÊûúË∑ùÁ¶ªÂ∫ïÈÉ®Ë∂ÖËøá100pxÔºåËÆ§‰∏∫Áî®Êà∑‰∏ªÂä®Âêë‰∏äÊªöÂä®
                if (distanceToBottom > 100) {
                    userScrolledRef.current = true;
                    console.log('Áî®Êà∑Âêë‰∏äÊªöÂä®ÔºåÂÅúÊ≠¢Ëá™Âä®Ë∑üÈöè');
                }
            };

            const stopGeneration = async () => {
                try {
                    const response = await fetch(`/stop?session_id=${encodeURIComponent(sessionId)}`);
                    if (response.ok) {
                        console.log('Â∑≤ÊàêÂäüÂèëÈÄÅÊâìÊñ≠ËØ∑Ê±Ç');
                        setIsLoading(false);
                    } else {
                        console.error('ÊâìÊñ≠ËØ∑Ê±ÇÂ§±Ë¥•:', response.status);
                    }
                } catch (error) {
                    console.error('ÊâìÊñ≠ËØ∑Ê±ÇÈîôËØØ:', error);
                }
            };

            // Â§ÑÁêÜÂõæÁâáÈÄâÊã©
            const handleImageSelect = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                files.forEach(file => {
                    if (!file.type.startsWith('image/')) {
                        console.warn('ÈùûÂõæÁâáÊñá‰ª∂:', file.name);
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64Data = event.target.result;
                        setSelectedImages(prev => [...prev, {
                            id: generateUUID(),
                            name: file.name,
                            base64: base64Data,
                            type: file.type
                        }]);
                    };
                    reader.readAsDataURL(file);
                });

                // Ê∏ÖÁ©∫ input ‰ª•‰æøÂèØ‰ª•ÈáçÂ§çÈÄâÊã©Áõ∏ÂêåÊñá‰ª∂
                e.target.value = '';
            };

            // ÁßªÈô§ÈÄâ‰∏≠ÁöÑÂõæÁâá
            const removeImage = (imageId) => {
                setSelectedImages(prev => prev.filter(img => img.id !== imageId));
            };

            const sendMessage = async () => {
                if ((!inputText.trim() && selectedImages.length === 0) || isLoading) return;

                // ÊûÑÂª∫ content ÂàóË°®
                const contentList = [];
                
                // Ê∑ªÂä†ÊñáÊú¨Âùó
                if (inputText.trim()) {
                    contentList.push({
                        type: 'text',
                        text: inputText.trim()
                    });
                }
                
                // Ê∑ªÂä†ÂõæÁâáÂùó
                selectedImages.forEach(img => {
                    // ‰ªé base64 data URL ‰∏≠ÊèêÂèñ media_type ÂíåÁ∫Ø base64 Êï∞ÊçÆ
                    const mediaTypeMatch = img.base64.match(/^data:([^;]+);base64,/);
                    const mediaType = mediaTypeMatch ? mediaTypeMatch[1] : 'image/png';
                    const base64Data = img.base64.replace(/^data:[^;]+;base64,/, '');
                    
                    contentList.push({
                        type: 'image',
                        source: {
                            type: 'base64',
                            media_type: mediaType,
                            data: base64Data
                        }
                    });
                });

                const userMessage = {
                    role: 'user',
                    content: inputText.trim(),
                    images: selectedImages.map(img => img.base64)
                };

                // Âú®Ê∑ªÂä†Ê∂àÊÅØ‰πãÂâçÈáçÁΩÆÊªöÂä®Áä∂ÊÄÅ
                userScrolledRef.current = false;
                console.log('ÂºÄÂßãÊñ∞ÂØπËØùÔºåÈáçÁΩÆÊªöÂä®Áä∂ÊÄÅ');

                setMessages(prev => [
                    ...prev,
                    userMessage,
                    // Á´ãÂç≥Ê∑ªÂä†‰∏Ä‰∏™Á©∫ÁöÑÂä©ÊâãÊ∂àÊÅØÁî®‰∫éÊòæÁ§∫Âä†ËΩΩÂä®Áîª
                    {
                        role: 'assistant',
                        contents: []
                    }
                ]);
                setInputText('');
                setSelectedImages([]);
                setIsLoading(true);

                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: sessionId,
                            content: contentList,
                            deepresearch: deepSearch
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    // Áî® Map Â≠òÂÇ®ÊØè‰∏™ msg_id ÂØπÂ∫îÁöÑ blockÔºàÊØè‰∏™ block ÊòØ‰∏Ä‰∏™ contents Êï∞ÁªÑÔºâ
                    let messageBlocks = new Map();
                    // Ê∂àÊÅØ ID ÁöÑÈ°∫Â∫èÂàóË°®
                    let messageIdOrder = [];
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n\n');
                        buffer = lines.pop() || '';
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    const msgId = data.msg_id || 'unknown';
                                    
                                    // Ë∞ÉËØïÊó•Âøó
                                    if (data.plan) {
                                        console.log('Received plan:', data.plan);
                                    }
                                    
                                    // Êõ¥Êñ∞ plan ‰ø°ÊÅØÔºàÂ¶ÇÊûú‰∏∫Á©∫ÂàôÊ∏ÖÈô§Ôºâ
                                    if (data.plan !== undefined) {
                                        setCurrentPlan(data.plan || null);
                                    }
                                    
                                    // Â¶ÇÊûúÊòØÊñ∞ÁöÑ msg_idÔºåËÆ∞ÂΩïÈ°∫Â∫è
                                    if (!messageBlocks.has(msgId)) {
                                        messageIdOrder.push(msgId);
                                    }
                                    
                                    // Áî®ÂΩìÂâç SSE Ê∂àÊÅØÁöÑ contents Ë¶ÜÁõñËØ• msg_id ÁöÑ block
                                    messageBlocks.set(msgId, data.contents || []);
                                    
                                    // Êõ¥Êñ∞Ê∂àÊÅØÊòæÁ§∫
                                    setMessages(prev => {
                                        const newMessages = [...prev];
                                        const lastMsg = newMessages[newMessages.length - 1];
                                        
                                        // ÊåâÁÖß msg_id È°∫Â∫èÁªÑÂêàÊâÄÊúâ block ÁöÑ contents
                                        const allContents = [];
                                        for (const id of messageIdOrder) {
                                            const blockContents = messageBlocks.get(id);
                                            if (blockContents && blockContents.length > 0) {
                                                allContents.push(...blockContents);
                                            }
                                        }
                                        
                                        if (lastMsg && lastMsg.role === 'assistant') {
                                            // Êõ¥Êñ∞ÊúÄÂêé‰∏ÄÊù°Âä©ÊâãÊ∂àÊÅØ
                                            newMessages[newMessages.length - 1] = {
                                                role: 'assistant',
                                                contents: allContents
                                            };
                                        } else {
                                            // Ê∑ªÂä†Êñ∞ÁöÑÂä©ÊâãÊ∂àÊÅØ
                                            newMessages.push({
                                                role: 'assistant',
                                                contents: allContents
                                            });
                                        }
                                        return newMessages;
                                    });
                                    
                                } catch (e) {
                                    console.error('Failed to parse SSE data:', e);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        contents: [{
                            type: 'error',
                            content: `ÈîôËØØ: ${error.message}`
                        }]
                    }]);
                } finally {
                    setIsLoading(false);
                    // ÂõûÁ≠îÁªìÊùüÂêéËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
                    setTimeout(() => {
                        if (inputRef.current) {
                            inputRef.current.focus();
                        }
                    }, 100);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    // Â¶ÇÊûúÊ≠£Âú®ÊòæÁ§∫ÊäÄËÉΩÊèêÁ§∫ÔºåÈÄâÊã©ÂΩìÂâçÊäÄËÉΩ
                    if (showSkillSuggestions) {
                        selectSkill(selectedSkillIndex);
                    } else {
                        sendMessage();
                    }
                } else if (e.key === 'ArrowDown' && showSkillSuggestions) {
                    e.preventDefault();
                    const filteredSkills = getFilteredSkills();
                    setSelectedSkillIndex(prev => 
                        prev < filteredSkills.length - 1 ? prev + 1 : prev
                    );
                } else if (e.key === 'ArrowUp' && showSkillSuggestions) {
                    e.preventDefault();
                    setSelectedSkillIndex(prev => prev > 0 ? prev - 1 : 0);
                } else if (e.key === 'Escape' && showSkillSuggestions) {
                    e.preventDefault();
                    setShowSkillSuggestions(false);
                }
            };

            // Ëé∑ÂèñËøáÊª§ÂêéÁöÑÊäÄËÉΩÂàóË°®
            const getFilteredSkills = () => {
                const slashIndex = inputText.indexOf('/');
                if (slashIndex === -1) return [];
                const query = inputText.substring(slashIndex + 1).toLowerCase().trim();
                if (query === '') return skills;
                return skills.filter(skill => {
                    const skillName = skill.name || '';
                    const skillDesc = skill.description || '';
                    return skillName.toLowerCase().includes(query) || 
                           skillDesc.toLowerCase().includes(query);
                });
            };

            // ÈÄâÊã©ÊäÄËÉΩ
            const selectSkill = (index) => {
                const filteredSkills = getFilteredSkills();
                if (index >= 0 && index < filteredSkills.length) {
                    const skill = filteredSkills[index];
                    const slashIndex = inputText.indexOf('/');
                    // ‰øùÁïô / ‰πãÂâçÁöÑÂÜÖÂÆπÔºåÊõøÊç¢ÊàêÊäÄËÉΩÂêç
                    const beforeSlash = slashIndex > 0 ? inputText.substring(0, slashIndex) : '';
                    setInputText(`${beforeSlash}/${skill.name} `);
                    setShowSkillSuggestions(false);
                    // ËÆæÁΩÆÂÖâÊ†áÂà∞Êú´Â∞æ
                    setTimeout(() => {
                        if (inputRef.current) {
                            inputRef.current.focus();
                            inputRef.current.setSelectionRange(
                                inputRef.current.value.length,
                                inputRef.current.value.length
                            );
                        }
                    }, 0);
                }
            };

            // ÂàáÊç¢ tool_use ÁöÑÂ±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ
            const toggleToolUse = (toolUseId) => {
                setExpandedToolUseIds(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(toolUseId)) {
                        newSet.delete(toolUseId);
                    } else {
                        newSet.add(toolUseId);
                    }
                    return newSet;
                });
            };

            // Êü•ÊâæÊåáÂÆö tool_use_id ÂØπÂ∫îÁöÑ tool_result
            const findToolResult = (toolUseId) => {
                for (const msg of messages) {
                    if (msg.role === 'assistant' && msg.contents) {
                        const toolResult = msg.contents.find(
                            item => item.type === 'tool_result' && item.tool_use_id === toolUseId
                        );
                        if (toolResult) return toolResult;
                    }
                }
                return null;
            };

            return (
                <>
                    <div className="chat-container">
                        <div className="chat-header">
                            <div className="chat-header-left">
                                <h1>AgentScope -- Alibaba</h1>
                                <div style={{ fontSize: '12px', opacity: 0.9, marginTop: '4px' }}>
                                    Session: {sessionId}
                                </div>
                            </div>
                            <button className="new-chat-button" onClick={() => window.location.reload()}>
                                + Êñ∞Âª∫ÂØπËØù
                            </button>
                        </div>
                        
                        <div className="chat-messages" ref={messagesContainerRef} onScroll={handleScroll}>
                        {messages.map((message, index) => (
                            <div key={index} className={`message ${message.role}`}>
                                <div className="message-bubble">
                                    {message.role === 'user' ? (
                                        <div>
                                            <div>{message.content}</div>
                                            {message.images && message.images.length > 0 && (
                                                <div className="user-images">
                                                    {message.images.map((imgSrc, idx) => (
                                                        <img key={idx} src={imgSrc} alt={`‰∏ä‰º†ÂõæÁâá ${idx + 1}`} />
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div>
                                            {message.contents.map((item, idx) => {
                                                // tool_result ‰∏çÁõ¥Êé•Ê∏≤ÊüìÔºå‰ºöÂú® tool_use ‰∏ãÊñπÂ±ïÁ§∫
                                                if (item.type === 'tool_result') {
                                                    return null;
                                                }
                                                
                                                // ÂØπ text Á±ªÂûã‰ΩøÁî® markdown Ê∏≤Êüì
                                                if (item.type === 'text' && typeof marked !== 'undefined') {
                                                    return (
                                                        <div 
                                                            key={idx} 
                                                            className={`message-content-item ${item.type} markdown-content`}
                                                            dangerouslySetInnerHTML={{ __html: marked.parse(item.content || '') }}
                                                        />
                                                    );
                                                }
                                                
                                                // tool_use Á±ªÂûãÔºöÂèØÁÇπÂáªÂ±ïÂºÄ/ÊäòÂè†ÔºåÂ±ïÁ§∫ÂØπÂ∫îÁöÑ tool_result
                                                if (item.type === 'tool_use') {
                                                    const toolUseId = item.tool_use_id;
                                                    const isExpanded = expandedToolUseIds.has(toolUseId);
                                                    const toolResult = findToolResult(toolUseId);
                                                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ‰∏îÊ≠£Âú®Âä†ËΩΩ
                                                    const isLastMessage = index === messages.length - 1;
                                                    const showLoading = !toolResult && isLastMessage && isLoading;
                                                    
                                                    return (
                                                        <div key={idx}>
                                                            <div 
                                                                className={`message-content-item ${item.type} ${showLoading ? 'loading' : ''}`}
                                                                onClick={() => toggleToolUse(toolUseId)}
                                                            >
                                                                <div className="tool-use-header">
                                                                    <span className={`tool-use-toggle ${isExpanded ? 'expanded' : ''}`}>
                                                                        ‚ñ∂
                                                                    </span>
                                                                    <span>{item.content}</span>
                                                                </div>
                                                            </div>
                                                            {isExpanded && toolResult && (
                                                                <div className="message-content-item tool_result">
                                                                    {toolResult.content}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                }
                                                
                                                // ÂÖ∂‰ªñÁ±ªÂûã‰øùÊåÅÂéüÊ†∑
                                                return (
                                                    <div key={idx} className={`message-content-item ${item.type}`}>
                                                        {item.content}
                                                    </div>
                                                );
                                            })}
                                            {index === messages.length - 1 && isLoading && (
                                                <div style={{ marginTop: '8px' }}>
                                                    <span className="loading-indicator"></span>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        <div ref={messagesEndRef} />
                    </div>
                    
                    <div className="chat-input-container">
                        {showSkillSuggestions && (
                            <div className="skill-suggestions">
                                {getFilteredSkills().length > 0 ? (
                                    getFilteredSkills().map((skill, index) => (
                                        <div 
                                            key={skill.name}
                                            className={`skill-item ${index === selectedSkillIndex ? 'selected' : ''}`}
                                            onClick={() => selectSkill(index)}
                                            onMouseEnter={() => setSelectedSkillIndex(index)}
                                        >
                                            <div className="skill-name">/{skill.name}</div>
                                            {skill.description && (
                                                <div className="skill-description">{skill.description}</div>
                                            )}
                                        </div>
                                    ))
                                ) : (
                                    <div className="skill-suggestions-empty">Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÊäÄËÉΩ</div>
                                )}
                            </div>
                        )}
                        
                        {/* ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• */}
                        <input
                            type="file"
                            ref={fileInputRef}
                            style={{ display: 'none' }}
                            accept="image/*"
                            multiple
                            onChange={handleImageSelect}
                        />
                        
                        {/* ÂõæÁâá‰∏ä‰º†ÊåâÈíÆ */}
                        <button
                            className="image-upload-btn"
                            onClick={() => fileInputRef.current?.click()}
                            disabled={isLoading}
                            title="‰∏ä‰º†ÂõæÁâá"
                        >
                            üì∑
                        </button>
                        
                        {/* Â∑≤ÈÄâÂõæÁâáÈ¢ÑËßà */}
                        {selectedImages.length > 0 && (
                            <div className="image-preview-container">
                                {selectedImages.map(img => (
                                    <div key={img.id} className="image-preview">
                                        <img src={img.base64} alt={img.name} />
                                        <button 
                                            className="remove-btn"
                                            onClick={() => removeImage(img.id)}
                                            title="ÁßªÈô§ÂõæÁâá"
                                        >
                                            √ó
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        <input
                            ref={inputRef}
                            type="text"
                            className="chat-input"
                            placeholder={selectedImages.length > 0 ? "Ê∑ªÂä†ÊñáÂ≠óÊèèËø∞ÔºàÂèØÈÄâÔºâ..." : "ËæìÂÖ•Ê∂àÊÅØÔºàËæìÂÖ• / Êü•ÁúãÂèØÁî®ÊäÄËÉΩÔºâ..."}
                            value={inputText}
                            onChange={(e) => setInputText(e.target.value)}
                            onKeyDown={handleKeyPress}
                            disabled={isLoading}
                        />
                        <div 
                            className={`deep-search-toggle ${deepSearch ? 'active' : ''}`}
                            onClick={() => setDeepSearch(!deepSearch)}
                        >
                            <span className="toggle-label">Ê∑±Â∫¶Á†îÁ©∂</span>
                            <div className="toggle-switch"></div>
                        </div>
                        {isLoading ? (
                            <button
                                className="stop-button"
                                onClick={stopGeneration}
                            >
                                <div className="stop-icon"></div>
                                ÊâìÊñ≠
                            </button>
                        ) : (
                            <button
                                className="send-button"
                                onClick={sendMessage}
                                disabled={!inputText.trim() && selectedImages.length === 0}
                            >
                                ÂèëÈÄÅ
                            </button>
                        )}
                    </div>
                </div>
                
                {currentPlan && renderPlan(currentPlan)}
            </>
            );
        }

        ReactDOM.render(<ChatApp />, document.getElementById('root'));
        console.log('‚úÖ React Ê∏≤ÊüìÂÆåÊàê:', new Date().toISOString());
    </script>
</body>
</html>
